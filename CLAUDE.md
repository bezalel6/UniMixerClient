# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Build System and Common Commands

This is a **PlatformIO ESP32 project** targeting ESP32-S3 Smart Display boards (primarily ESP32-8048S070C).

### Essential Commands
```bash
# Build the project
pio run

# Build and upload to device
pio run --target upload

# Serial monitor
pio device monitor

# Clean build
pio run --target clean

# Check for compilation errors
pio check

# Generate build information
python scripts/get_build_info.py

# Upload binary via custom script
python scripts/upload_bin.py
```

### Default Board Configuration
- **Primary board**: `esp32-8048S070C` (8-inch 800x480 display)
- **Framework**: Arduino on ESP32
- **Platform**: espressif32@6.5.0
- **Monitor speed**: 112500 baud

## Architecture Overview

### Dual-Core ESP32-S3 Architecture
This is a **dual-core embedded system** with specific core responsibilities:

- **Core 0**: LVGL/UI rendering, Audio processing, Application logic (high priority)
- **Core 1**: Dedicated messaging engine with interrupt-driven I/O
- **No network tasks**: Maximum UI/audio performance optimization

### Key System Components

#### 1. Application Layer (`src/core/`)
- **AppController**: Main application orchestration and system initialization
- **TaskManager**: Multi-core task coordination and management
- **main.cpp**: Clean entry point with dual-core logging filter

#### 2. LVGL Wrapper System (`src/ui/wrapper/`) - DEPRECATED
**⚠️ DO NOT USE THE LVGL WRAPPER - IT IS DEPRECATED AND WILL BE REMOVED**

- **Status**: Deprecated, scheduled for removal
- **Alternative**: Use SquareLine Studio for UI design and direct LVGL calls
- **Migration**: See migration guide below

#### 3. Type-Safe Messaging System (`src/messaging/`)
**"Brutally simplified"** messaging system with tagged union approach:

- **Core message structure**: Single `Message` struct with tagged union
- **8 predefined message types**: Reduced from 30+ for simplicity
- **Direct field access**: No complex unpacking or variants
- **Binary protocol**: CRC16 validation, escape sequences, state machine parsing
- **Dual-core safety**: Mutex protection for Core 0 ↔ Core 1 communication

#### 4. Display Management (`src/display/`)
- **DisplayManager**: LVGL integration and display control
- **LVGLSDFilesystem**: SD card integration for assets
- **Boot and progress screens**: System initialization UI

#### 5. Hardware Abstraction (`src/hardware/`)
- **DeviceManager**: ESP32 hardware abstraction
- **SDManager**: SD card management for assets and firmware

## Key Design Patterns

### 1. CRTP for Type Safety
```cpp
template <typename Derived>
class WidgetBase {
    Derived& show() { return static_cast<Derived&>(*this); }
};
```

### 2. Tagged Union Messages
```cpp
struct Message {
    String type;
    union {
        AudioData audio;
        AssetData asset;
    } data;
};
```

### 3. Factory Pattern for Messages
```cpp
Message msg = Message::createStatusRequest(deviceId);
Message volMsg = Message::createVolumeChange("chrome", 75, deviceId);
```

### 4. Fluent Interface for UI
```cpp
container.init()
    .setCardStyle(true)
    .setSize(320, 240)
    .center();
```

## Critical Development Notes

### File Generation
- **UI files** in `src/ui/` are **auto-generated** by SquareLine Studio - **DO NOT MODIFY**
- **Build info** is auto-generated by `scripts/get_build_info.py`
- **SquareLine project** files are in `SquarelineProj/`

### Memory Management
- **PSRAM usage**: Check free PSRAM with `ESP.getFreePsram()`
- **Heap monitoring**: Use `ESP.getFreeHeap()` for memory debugging
- **LVGL memory**: Monitor LVGL heap usage for display performance

### Dual-Core Safety
- **Core 0**: UI, audio, application logic
- **Core 1**: Messaging engine only
- **Use mutexes** for shared data structures
- **Logging filter**: CoreLoggingFilter manages per-core logging

### Testing and Validation
- **No automated tests**: Manual testing via serial monitor
- **Message validation**: Use safe JSON extraction macros
- **UI testing**: Test on actual hardware with 8-inch display

## Common Development Patterns

### Adding New UI Components
1. **Use SquareLine Studio** for visual UI design
2. **Use direct LVGL calls** for dynamic elements
3. **DO NOT use the deprecated wrapper** from `src/ui/wrapper/`
4. Place dynamic UI code in appropriate handlers

### LVGLWrapper Migration Guide
**The LVGLWrapper is deprecated. Here's how to migrate:**

#### Instead of wrapper classes:
```cpp
// ❌ OLD (deprecated wrapper)
auto container = new UI::Wrapper::Container("my_container");
container->init(parent);
container->setSize(320, 240)->setCardStyle(true);

// ✅ NEW (direct LVGL)
lv_obj_t* container = lv_obj_create(parent);
lv_obj_set_size(container, 320, 240);
// Apply styling directly or use helper functions
```

#### For common patterns:
```cpp
// ❌ OLD (wrapper)
label->setHeadingStyle()->setText("Title");

// ✅ NEW (direct)
lv_label_set_text(label, "Title");
lv_obj_set_style_text_font(label, &lv_font_montserrat_24, 0);
```

### Adding New Message Types
1. Extend `Message` struct union in `src/messaging/Message.h`
2. Add factory method for type-safe creation
3. Update message router registration
4. Add safe JSON extraction logic

### Debugging Tips
- **Serial monitor**: Use `pio device monitor` at 112500 baud
- **Core logging**: Enable/disable CoreLoggingFilter for debugging
- **BSOD system**: Check `BSODHandler.h` for critical failure handling
- **Memory debugging**: Monitor heap and PSRAM usage

## Hardware Specifics

### Supported Boards
Multiple ESP32 display boards supported via JSON configurations in `boards/`:
- ESP32-8048S070C (primary 8-inch)
- ESP32-4827S043C (4.3-inch)
- ESP32-3248S035C (3.5-inch)
- And many others

### Pin Configurations
- **Display**: Configured via board JSON files
- **Audio**: Built-in audio support for compatible boards
- **Touch**: Capacitive touch support
- **SD card**: Asset and firmware storage

## OTA Update System

The project includes a Node.js-based OTA server in `server/`:
- **Firmware hosting**: Stores and serves firmware binaries
- **Docker deployment**: Full containerized deployment
- **Health checking**: Automatic health monitoring
- **Version management**: Tracks firmware versions and statistics

## Documentation

Extensive documentation in `docs/` covering:
- **Architecture guides**: Core system design
- **LVGL wrapper**: Modern C++ wrapper usage
- **Messaging system**: Type-safe messaging patterns
- **Performance optimization**: Multi-core optimization strategies
- **Debugging guides**: Troubleshooting and debugging techniques

## Deployment Notes

### Build and Upload Workflow
- **Important Development Flow**: Running *JUST* a pio build/run is NEVER correct. you should always attempt an upload to keep a connected device updated along with the codebase.
